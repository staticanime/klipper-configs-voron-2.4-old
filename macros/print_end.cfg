[gcode_macro PRINT_END]
description: "G-code to run at the end of a print. Replace your slicer's end G-code with this"
gcode:
  SAVE_GCODE_STATE NAME=STATE_PRINT_END

  M400                           ; wait for buffer to clear
  TURN_OFF_HEATERS
  SAFE_RETRACT
  SAFE_PARK
   
  M220 S100 ;Reset Speed factor override percentage to default (100%)
  M221 S100 ;Reset Extrude factor override percentage to default (100%)

  M84 X Y E ;Disable all steppers but Z
  
  BED_MESH_CLEAR 
  RESTORE_GCODE_STATE NAME=STATE_PRINT_END
  SET_FAN_SPEED FAN=exhaust_fan SPEED=0.5
  SET_PIN PIN=caselight VALUE=0.1

  M117 Print Complete